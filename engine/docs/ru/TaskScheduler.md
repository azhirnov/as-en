Система ассинхронных задач, планировщик и менеджер потоков.


## Ассинхронные задачи (AsyncTask)

Базовый интерфейс для всех ассинхронных задач.<br/>
Хранит статус выполнения задачи, зависимости, тип очереди и тд.

Виртуальный метод `Run()` гарантированно выполнится только после того как все входные зависимости завершены - их методы `Run` или `OnCancel` были вызваны.
Перед вызовом `Run()` кэш ЦП загружается (acquire), а после вызова - выгружается (release), дополнительные синхронизации не требуются.

Внутри реализации метода `Run()` можно вызвать:
 * метод `OnFailure()` - ошибка при выполнении задачи, меняет статус и вызывает метод `OnCancel()` после завершения `Run()`.
 * метод `Continue()` - возвращает задачу в очередь, чтобы повторно вызвать метод `Run()`. Может принимать список зависимых задач.

Исходник: [AsyncTask.h](../../src/threading/TaskSystem/AsyncTask.h#L88)


### Корутины (CoroTask)

Корутины из C++20 сделанные поверх AsyncTask.<br/>
Интерфейс сделан через неблокирующие `co_await`:
```cpp
bool        co_await Coro_IsCanceled
EStatus     co_await Coro_Status
ETaskQueue  co_await Coro_TaskQueue
```

Исходник: [AsyncTask.h](../../src/threading/TaskSystem/AsyncTask.h#L287)


### Корутины (Coroutine<>)

Корутины из C++20 сделанные поверх AsyncTask, могут хранить значение внутри и возвращать его через `co_await` после выполнения задачи.

Исходник: [Coroutine.h](../../src/threading/TaskSystem/Coroutine.h), [Тесты](../../tests/threading/UnitTest_Coroutine.cpp)


### Промис (Promise<>)

Повторяет функционал корутин на C++17, который поддерживается многими компиляторами.

`MakePromiseFromValue()` - если аргумент dependsOn пустой, то задача не добавляется в очередь.<br/>
`MakePromiseFrom() и MakePromiseFromArray()` - объединяют результаты промисов в один.

Исходник: [Promise.h](../../src/threading/TaskSystem/Promise.h), [Тесты](../../tests/threading/UnitTest_Promise.cpp)


### Типы очередей (ETaskQueue / EThread)

 * __Main__ - единственный поток, который обрабатывает вызовы ОС (окно, ввод и тд).
 * __PerFrame__ - поток с высоким приоритетом, предназначен для коротких задач в пределах кадра, это физика, логика, графика и тд. Разрешен доступ к Vulkan и Metal API.
 * __Renderer__ - аналогично PerFrame, но используется чтобы ограничить количество потоков с доступом к коммандному пулу (Vulkan). Должны использоваться только `RenderTask` и `RenderTaskCoro`. Память для записи комманд к буфер выделяется под каждый поток (VkCommandPool).
 * __Background__ - рабочий поток с низким приоритетом. Рекомендуется использовать для тяжелых задач:
	- Графическое АПИ: компиляция пайплайнов, выделение памяти и тд.
	- Доступ к файлам.
	- Работа с сетью.
 * __FileIO__ - не является очередью, нужен для передачи управления в ОС, чтобы обработать завершенные ассинхроные команды чтения/записи в файл.
 
Исходник: [EThread.h](../../src/threading/TaskSystem/EThread.h)


### Зависимости между задачами

Поддерживаются сильные и слабые зависимости.

Если слабая зависимость отменяется или завершается с ошибкой, то зависящая от него задача все равно запустится. Явно указывается через `WeakDep{task}`.

Если сильная зависимость отменяется или завершается с ошибкой, то зависящая от него задача также отменяется. Неявно используется сильная зависимость, явно указывается через `StrongDep{task}`.


## Планировщик задач для ЦП (TaskScheduler)

Метод `Run()` используется для добавления задач в очередь, в случае ошибки задача помечается как отмененная.
Если не получилось создать задачу (исключение в конструкторе и тд), то возвращается задача-заглушка с отмененным состоянием.


Метод `ProcessTask()` вызывается потоком, чтобы найти задачу в указаных очередях и выполнить ее - вызывается `AsyncTask::Run()`, либо если задача отменена, то вызывается `AsyncTask::OnCancel()` и продолжается поиск задачи.

Исходник: [TaskScheduler.h](../../src/threading/TaskSystem/TaskScheduler.h#L260)


## Кастомизация зависимостей для ассинхронных задач (ITaskDependencyManager)

У каждой задачи есть битовое поле на 64 бита, которое меняется атомарно.
Когда все входные зависимости для задачи выполнены, планировщик может достать задачу из очереди и начать выполнение.

Менеджер зависимостей хранит указатель на задачу и номер бита, к которому привязана зависимость.

Исходник: [TaskScheduler.h](../../src/threading/TaskSystem/TaskScheduler.h#L114)


## Управление потоками (ThreadManager)

Создает потоки, привязывает их к ядрам ЦП и к очередям в планировщике задач.

Если ЦП содержит энергоэффективные ядра, то потоки с `Background, FileIO` будут привязаны к этим ядрам, а потоки с `Main, PerFrame, Renderer` будут привязаны к производительным ядрам ЦП.

Исходник: [ThreadManager.h](../../src/threading/TaskSystem/ThreadManager.h)

